<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>flask-gpt-stack MVP</title>
  <style>
    :root {
      color-scheme: light;
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --line: #e2e8f0;
      --accent: #111827;
      --accent-soft: #f1f5f9;
      --shadow: 0 10px 28px rgba(15, 23, 42, 0.08);
    }
    * { box-sizing: border-box; }
    body {
      font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }
    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 28px 22px 60px;
      display: grid;
      gap: 18px;
    }
    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 20px 22px;
      background: linear-gradient(120deg, #111827 0%, #1f2937 50%, #0f172a 100%);
      color: #fff;
      border-radius: 18px;
      box-shadow: var(--shadow);
    }
    .page-header h1 {
      font-size: 20px;
      margin: 0 0 6px;
    }
    .page-header p {
      margin: 0;
      font-size: 13px;
      color: rgba(255, 255, 255, 0.8);
    }
    .card {
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 20px;
      box-shadow: var(--shadow);
      background: var(--card);
      display: grid;
      gap: 14px;
    }
    h1 { font-size: 18px; margin: 0; }
    h2 { font-size: 15px; margin: 0; }
    .section-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .section-title .muted { margin-top: 6px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .row > * { margin: 2px 0; }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px 16px;
      align-items: end;
    }
    .field {
      display: grid;
      gap: 6px;
    }
    label { font-size: 12px; color: var(--muted); font-weight: 600; }
    input[type="text"], input[type="number"], input[type="date"], select {
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 10px;
      min-width: 0;
      background: #fff;
      font-size: 13px;
      color: var(--text);
    }
    input[type="file"] { padding: 6px; }
    button {
      padding: 10px 14px;
      border: 1px solid var(--accent);
      background: var(--accent);
      color: white;
      border-radius: 10px;
      cursor: pointer;
      font-size: 13px;
    }
    button.secondary { background: white; color: var(--accent); }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .muted { color: var(--muted); font-size: 13px; }
    .hr { height: 1px; background: var(--line); margin: 6px 0; }
    .kv { font-size: 13px; color: var(--text); }
    .kv code { background: var(--accent-soft); padding: 2px 6px; border-radius: 6px; }
    .progress-wrap { width: 100%; max-width: 720px; height: 14px; border-radius: 999px; background: #f3f4f6; overflow: hidden; border: 1px solid var(--line); }
    .progress-bar { height: 100%; width: 0%; background: var(--accent); transition: width .2s ease; }
    .statusline { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid var(--line); background: #fafafa; }
    .pill.ok { border-color: #86efac; background: #f0fdf4; }
    .pill.bad { border-color: #fca5a5; background: #fef2f2; }
    a.btnlink { display: inline-block; padding: 9px 12px; border-radius: 10px; border: 1px solid var(--accent); text-decoration: none; font-size: 13px; }
    a.btnlink.primary { background: var(--accent); color: white; }
    a.btnlink.secondary { background: white; color: var(--accent); }
    pre { white-space: pre-wrap; word-break: break-word; background: #0b1020; color: #e5e7eb; padding: 12px; border-radius: 12px; font-size: 12px; max-height: 260px; overflow: auto; margin: 0; }

    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid var(--line); padding: 8px; font-size: 13px; vertical-align: top; }
    th { background: #f8fafc; text-align: left; }
    .nowrap { white-space: nowrap; }
    .small { font-size: 12px; color: var(--muted); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .btn-mini { padding: 6px 10px; border-radius: 8px; font-size: 12px; }
    .hidden { display: none; }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      background: #f8fafc;
      border: 1px dashed var(--line);
      border-radius: 12px;
      padding: 10px 12px;
    }
    .modal {
      position: fixed;
      inset: 0;
      z-index: 50;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal.hidden {
      display: none;
    }
    .modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
    }
    .modal-card {
      position: relative;
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      width: min(980px, 92vw);
      max-height: 90vh;
      overflow: auto;
      z-index: 1;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.2);
    }
    .two-col {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }
    .inner-card {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="page-header">
      <div>
        <h1>flask-gpt-stack · 操作控制台</h1>
        <p>统一入口：证书索引、知识库检索、评审索引生成与任务闭环。</p>
      </div>
      <div class="small">MVP 控制台</div>
    </header>

    <!-- ============ 索引搜索（证书库） ============ -->
    <div class="card">
      <div class="section-title">
        <div>
          <h1>第一步：证书索引</h1>
          <div class="muted">提示：如果数据库里还没导入对应数据，搜索会返回空。</div>
        </div>
        <div class="kv">total：<code id="searchTotal">0</code></div>
      </div>

      <div class="form-grid">
        <div class="field">
          <label>关键词 q（模糊查询）</label>
          <input id="searchQ" type="text" placeholder="例如：专利 / 营业执照 / 身份证正面" />
        </div>

        <div class="field">
          <label>scope</label>
          <select id="searchScope">
            <option value="">ALL</option>
            <option value="PERSON">PERSON</option>
            <option value="COMPANY">COMPANY</option>
          </select>
        </div>

        <div class="field">
          <label>操作</label>
          <div class="row">
            <button id="btnSearch">搜索</button>
            <button id="btnSearchReset" class="secondary">清空</button>
          </div>
        </div>
      </div>

      <div class="toolbar">
        <div class="small" id="searchReqUrl"></div>
        <div class="row">
          <button id="btnPrev" class="secondary">上一页</button>
          <span class="kv">page：<code id="searchPage">1</code></span>
          <button id="btnNext" class="secondary">下一页</button>
        </div>
      </div>

      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>file</th>
            </tr>
          </thead>
          <tbody id="searchTbody">
            <tr><td colspan="1" class="muted">请先搜索</td></tr>
          </tbody>
        </table>
      </div>

      <div>
        <div class="muted">搜索日志</div>
        <pre id="searchLog"></pre>
      </div>
    </div>

    <!-- ============ 证件管理（CRUD） ============ -->
    <div class="card">
      <div class="section-title">
        <div>
          <h1>证件管理</h1>
          <div class="muted">支持证件新增、修改、删除与列表分页。</div>
        </div>
        <div class="kv">total：<code id="certTotal">0</code></div>
      </div>

      <div class="form-grid">
        <div class="field">
          <label>选中证件（点击表格行）</label>
          <input id="certEvidenceId" type="text" placeholder="证件ID" readonly />
        </div>

        <div class="field">
          <label>操作</label>
          <div class="row">
            <button id="btnCertOpenCreate">新增</button>
            <button id="btnCertDelete" class="secondary">删除</button>
          </div>
        </div>
      </div>

      <div class="toolbar">
        <div class="small" id="certReqUrl"></div>
        <div class="row">
          <button id="certPrev" class="secondary">上一页</button>
          <span class="kv">page：<code id="certPage">1</code></span>
          <button id="certNext" class="secondary">下一页</button>
        </div>
      </div>

      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th class="nowrap">evidence_id</th>
              <th class="nowrap">owner</th>
              <th class="nowrap">doc_type</th>
              <th class="nowrap">status</th>
              <th>file</th>
            </tr>
          </thead>
          <tbody id="certTbody">
            <tr><td colspan="5" class="muted">暂无数据</td></tr>
          </tbody>
        </table>
      </div>

      <div>
        <div class="muted">操作日志</div>
        <pre id="certLog"></pre>
      </div>
    </div>

    <div id="certCreateModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-card">
        <div class="section-title">
          <div>
            <h2>新增证件</h2>
            <div class="muted">公司证书 / 人员信息</div>
            <div class="small">当前选中：<span id="certSelectedLabel">未选择</span></div>
          </div>
          <button id="btnCertCloseCreate" class="secondary">关闭</button>
        </div>

        <div class="two-col">
          <div class="card inner-card">
            <h3>公司证书新增</h3>
            <div class="form-grid">
              <div class="field">
                <label>证书详细名称（file）</label>
                <input id="companyCertName" type="text" placeholder="例如：ISO9001 质量管理体系认证证书_01.png" />
              </div>
              <div class="field">
                <label>证书类型（doc_type，自动识别）</label>
                <select id="companyCertType">
                  <option value="">请选择</option>
                  <option value="patent">专利</option>
                  <option value="business_license">营业执照</option>
                  <option value="qualification">资质证书</option>
                  <option value="tax_certificate">税务证明</option>
                </select>
              </div>
              <div class="field">
                <label>上传图片</label>
                <input id="companyCertFile" type="file" />
              </div>
              <div class="field">
                <label>操作</label>
                <div class="row">
                  <button id="btnCompanyCertCreate">新增公司证书</button>
                  <button id="btnCompanyCertUpdate" class="secondary hidden">保存公司修改</button>
                </div>
              </div>
            </div>
          </div>

          <div class="card inner-card">
            <h3>人员信息新增</h3>
            <div class="form-grid">
              <div class="field">
                <label>人员名称（owner_name）</label>
                <input id="personName" type="text" placeholder="例如：武全胜" />
              </div>
              <div class="field">
                <label>证书详细名称（file）</label>
                <input id="personCertName" type="text" placeholder="例如：高级信息系统项目管理师-武全胜.png" />
              </div>
              <div class="field">
                <label>证书类型（doc_type，自动识别）</label>
                <select id="personCertType">
                  <option value="">请选择</option>
                  <option value="network_engineer">网络工程师</option>
                  <option value="project_manager">项目管理师</option>
                  <option value="diploma">学历证书</option>
                </select>
              </div>
              <div class="field">
                <label>上传图片</label>
                <input id="personCertFile" type="file" />
              </div>
              <div class="field">
                <label>操作</label>
                <div class="row">
                  <button id="btnPersonCertCreate">新增人员证件</button>
                  <button id="btnPersonCertUpdate" class="secondary hidden">保存人员修改</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="muted small">证书类型会根据证件名称尝试自动匹配，可手动调整。</div>
      </div>
    </div>

    <!-- ============ 知识库检索与导出（离线切片后使用） ============ -->
    <div class="card">
      <div class="section-title">
        <div>
          <h1>第二步：知识库检索与导出</h1>
          <div class="muted">
            说明：招标文件已通过离线脚本切片入库（<span class="mono">kb_documents/kb_blocks</span>，切片文件落到 <span class="mono">storage/kb/blocks/</span>）。
            <br/>这里支持：关键词检索（如“产品功能”）→ 返回相关内容 → 一键导出 Word（docx）。
          </div>
        </div>
        <div class="kv">total：<code id="kbTotal">0</code></div>
      </div>

      <div class="form-grid">
        <div class="field">
          <label>关键词 query</label>
          <input id="kbQuery" type="text" placeholder="例如：产品功能 / 技术方案 / 交付计划" />
        </div>

        <div class="field">
          <label>tag（可选）</label>
          <input id="kbTag" type="text" placeholder="例如：tender" />
        </div>

        <div class="field">
          <label>标题关键词（可选，逗号分隔）</label>
          <input id="kbTitleKeywords" type="text" placeholder="例如：功能,范围,需求" />
        </div>

        <div class="field">
          <label>top_k（最多返回）</label>
          <input id="kbTopK" type="number" value="50" min="1" max="500" />
        </div>

        <div class="field">
          <label>page_size</label>
          <select id="kbPageSize">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>

        <div class="field">
          <label>操作</label>
          <div class="row">
            <button id="btnKbSearch">检索</button>
            <button id="btnKbReset" class="secondary">清空</button>
          </div>
        </div>

        <div class="field">
          <label>导出</label>
          <button id="btnKbExport" class="secondary">导出当前检索结果（docx）</button>
        </div>
      </div>

      <div class="toolbar">
        <div class="small" id="kbReqInfo"></div>
        <div class="row">
          <button id="btnKbPrev" class="secondary">上一页</button>
          <span class="kv">page：<code id="kbPage">1</code></span>
          <button id="btnKbNext" class="secondary">下一页</button>
        </div>
      </div>

      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th class="nowrap">score</th>
              <th>section_title</th>
              <th>content_text（预览）</th>
              <th class="nowrap">操作</th>
            </tr>
          </thead>
          <tbody id="kbTbody">
            <tr><td colspan="4" class="muted">请先检索</td></tr>
          </tbody>
        </table>
      </div>

      <div>
        <div class="muted">选中内容（完整）</div>
        <pre id="kbPreview"></pre>
      </div>

      <div>
        <div class="muted">知识库日志</div>
        <pre id="kbLog"></pre>
      </div>
    </div>

    <!-- ============ 任务闭环（你已有） ============ -->
    <div class="card">
      <div class="section-title">
        <div>
          <h1>第三步：任务闭环（上传 → 选择脚本 → 创建任务 → 轮询 → 下载）</h1>
          <div class="muted">上传 → 选择脚本 → 创建任务 → 进度轮询 → 下载 XLSX/JSON/DOCX</div>
        </div>
        <div class="kv">job_id：<code id="jobId">-</code></div>
      </div>

      <div class="form-grid">
        <div class="field">
          <label>选择文件（仅 txt / docx，≤20MB）</label>
          <input id="fileInput" type="file" accept=".txt,.docx" />
        </div>
        <div class="field">
          <label>上传</label>
          <button id="btnUpload">上传文件</button>
        </div>
        <div class="field">
          <label>file_id</label>
          <div class="kv"><code id="fileId">-</code></div>
        </div>
      </div>

      <div class="form-grid">
        <div class="field">
          <label>脚本选择</label>
          <select id="scriptSelect">
            <option value="">加载中...</option>
          </select>
        </div>

        <div class="field">
          <label>模型 ID（MVP 任意字符串）</label>
          <input id="modelInput" type="text" value="mock" />
        </div>

        <div class="field">
          <label>操作</label>
          <button id="btnCreateJob" disabled>创建任务</button>
        </div>
      </div>

      <div class="statusline">
        <span class="pill" id="pillStatus">status: -</span>
        <span class="pill" id="pillStage">stage: -</span>
        <span class="pill" id="pillProgress">progress: 0%</span>
      </div>

      <div>
        <div class="progress-wrap">
          <div id="progressBar" class="progress-bar"></div>
        </div>
      </div>

      <div class="row">
        <a id="btnDownloadXlsx" class="btnlink primary" href="#" style="display:none;">下载 result.xlsx</a>
        <a id="btnDownloadJson" class="btnlink secondary" href="#" style="display:none;">下载 result.json</a>
        <a id="btnDownloadDocx" class="btnlink secondary" href="#" style="display:none;">下载 result.docx</a>
        <button id="btnReset" class="secondary">重置</button>
      </div>

      <div>
        <div class="muted">任务列表</div>
        <table>
          <thead>
            <tr>
              <th class="nowrap">job_id</th>
              <th class="nowrap">status</th>
              <th class="nowrap">artifact</th>
            </tr>
          </thead>
          <tbody id="jobListTbody">
            <tr><td colspan="3" class="muted">暂无任务</td></tr>
          </tbody>
        </table>
      </div>

      <div>
        <div class="muted">任务日志</div>
        <pre id="log"></pre>
      </div>
    </div>

    <!-- ============ 一键生成：评审办法索引目录（模板评分大类 + result.xlsx 要求 + KB证据） ============ -->
    <div class="card">
      <div class="section-title">
        <div>
          <h1>第四步：一键生成评审办法索引</h1>
          <div class="muted">先运行任务生成 <span class="mono">result.xlsx</span>，再填写 job_id 预览/生成。</div>
        </div>
        <div class="kv">requirements：<code id="riReqCount">0</code></div>
      </div>

      <div class="form-grid">
        <div class="field">
          <label>job_id（默认使用下方任务区的 job_id）</label>
          <input id="riJobId" type="text" placeholder="例如：xxxx-xxxx-xxxx" />
        </div>

        <div class="field">
          <label>KB tag（可选）</label>
          <input id="riKbTag" type="text" value="tender" placeholder="例如：tender" />
        </div>

        <div class="field">
          <label>每个评分大类证据条数</label>
          <input id="riTopN" type="number" value="3" min="1" max="10" />
        </div>

        <div class="field">
          <label>模板路径（可选）</label>
          <input id="riTemplatePath" type="text" value="storage/kb/templates/评分大类.docx" />
        </div>

        <div class="field">
          <label>预览条数 limit</label>
          <input id="riLimit" type="number" value="200" min="50" max="2000" />
        </div>

        <div class="field">
          <label>操作</label>
          <div class="row">
            <button id="btnRiLoad">预览要求表</button>
            <button id="btnRiGenerate" class="secondary">一键生成（docx）</button>
          </div>
        </div>
      </div>

      <div>
        <h2>招标文件要求表（category / item / value / source）预览</h2>
        <div style="overflow:auto;">
          <table>
            <thead>
              <tr>
                <th class="nowrap">category</th>
                <th class="nowrap">item</th>
                <th>value</th>
                <th>source</th>
              </tr>
            </thead>
            <tbody id="riReqTbody">
              <tr><td colspan="4" class="muted">请先预览</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div>
        <div class="muted">生成日志</div>
        <pre id="riLog"></pre>
      </div>
    </div>
  </div>

<script>
(function () {
  const el = (id) => document.getElementById(id);

  function escapeHtml(s) {
    return String(s ?? "")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;");
  }

  function downloadBlobAs(blob, filename) {
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    window.URL.revokeObjectURL(url);
  }

  // =======================
  // 1) 证书索引 Search
  // =======================
  const searchQ = el("searchQ");
  const searchScope = el("searchScope");
  const btnSearch = el("btnSearch");
  const btnSearchReset = el("btnSearchReset");
  const btnPrev = el("btnPrev");
  const btnNext = el("btnNext");

  const searchTotal = el("searchTotal");
  const searchPage = el("searchPage");
  const searchReqUrl = el("searchReqUrl");
  const searchTbody = el("searchTbody");
  const searchLog = el("searchLog");

  const searchPageSize = 5;
  let searchState = { page: 1, total: 0 };

  function slog(msg) {
    const line = `[${new Date().toLocaleTimeString()}] ${msg}`;
    searchLog.textContent = (searchLog.textContent ? (searchLog.textContent + "\n") : "") + line;
    searchLog.scrollTop = searchLog.scrollHeight;
  }

  function buildSearchUrl(page) {
    const params = new URLSearchParams();
    const qv = (searchQ.value || "").trim();
    if (qv) params.set("q", qv);

    const scopev = (searchScope.value || "").trim();
    if (scopev) params.set("scope", scopev);

    params.set("page_size", String(searchPageSize));
    params.set("page", String(page));

    return "/api/v1/index/search?" + params.toString();
  }

  function renderIndexItems(items) {
    if (!items || items.length === 0) {
      searchTbody.innerHTML = `<tr><td colspan="1" class="muted">无结果</td></tr>`;
      return;
    }

    const rows = items.map(it => {
      const file = it.file || {};
      const certName = it.cert_no || "";
      const fileInfo = `
        <div><b>${escapeHtml(certName)}</b></div>
        <div class="small">${escapeHtml(file.mime_type || "")} · ${escapeHtml(file.size_bytes || "")} bytes</div>
        <div class="small">${escapeHtml(file.storage_rel_path || "")}</div>
      `;

      return `
        <tr>
          <td>${fileInfo}</td>
        </tr>
      `;
    }).join("");

    searchTbody.innerHTML = rows;
  }

  async function doIndexSearch(page) {
    const url = buildSearchUrl(page);
    searchReqUrl.textContent = "GET " + url;
    slog("search: " + url);

    btnSearch.disabled = true;
    try {
      const resp = await fetch(url, { method: "GET" });
      const data = await resp.json().catch(() => ({}));
      if (!resp.ok) throw new Error(data.message || `HTTP ${resp.status}`);

      searchState.page = data.page || page;
      searchState.total = data.total || 0;

      searchPage.textContent = String(searchState.page);
      searchTotal.textContent = String(searchState.total);

      renderIndexItems(data.items || []);

      btnPrev.disabled = (searchState.page <= 1);
      btnNext.disabled = (searchState.page * searchPageSize >= searchState.total);

    } catch (e) {
      slog("error: " + (e.message || e));
      searchTbody.innerHTML = `<tr><td colspan="1" class="muted">查询失败：${escapeHtml(e.message || e)}</td></tr>`;
    } finally {
      btnSearch.disabled = false;
    }
  }

  btnSearch.addEventListener("click", () => doIndexSearch(1));
  btnPrev.addEventListener("click", () => doIndexSearch(Math.max(1, (searchState.page || 1) - 1)));
  btnNext.addEventListener("click", () => doIndexSearch((searchState.page || 1) + 1));

  btnSearchReset.addEventListener("click", () => {
    searchQ.value = "";
    searchScope.value = "";
    searchState.page = 1;
    searchState.total = 0;
    searchPage.textContent = "1";
    searchTotal.textContent = "0";
    searchReqUrl.textContent = "";
    searchLog.textContent = "";
    searchTbody.innerHTML = `<tr><td colspan="1" class="muted">请先搜索</td></tr>`;
  });

  searchQ.addEventListener("keydown", (e) => {
    if (e.key === "Enter") doIndexSearch(1);
  });

  // =======================
  // 1.5) 证件管理 CRUD
  // =======================
  const certEvidenceId = el("certEvidenceId");
  const btnCertOpenCreate = el("btnCertOpenCreate");
  const btnCertDelete = el("btnCertDelete");
  const certPrev = el("certPrev");
  const certNext = el("certNext");
  const certPage = el("certPage");
  const certTotal = el("certTotal");
  const certReqUrl = el("certReqUrl");
  const certTbody = el("certTbody");
  const certLog = el("certLog");

  const certCreateModal = el("certCreateModal");
  const btnCertCloseCreate = el("btnCertCloseCreate");
  const certSelectedLabel = el("certSelectedLabel");
  const companyCertName = el("companyCertName");
  const companyCertType = el("companyCertType");
  const companyCertFile = el("companyCertFile");
  const btnCompanyCertCreate = el("btnCompanyCertCreate");
  const btnCompanyCertUpdate = el("btnCompanyCertUpdate");
  const personName = el("personName");
  const personCertName = el("personCertName");
  const personCertType = el("personCertType");
  const personCertFile = el("personCertFile");
  const btnPersonCertCreate = el("btnPersonCertCreate");
  const btnPersonCertUpdate = el("btnPersonCertUpdate");

  const certPageSize = 5;
  let certState = { page: 1, total: 0 };
  let selectedCert = null;

  function certLogLine(msg) {
    const line = `[${new Date().toLocaleTimeString()}] ${msg}`;
    certLog.textContent = (certLog.textContent ? (certLog.textContent + "\n") : "") + line;
    certLog.scrollTop = certLog.scrollHeight;
  }

  function buildCertListUrl(page) {
    const params = new URLSearchParams();
    params.set("page", String(page));
    params.set("page_size", String(certPageSize));
    return "/api/v1/certs?" + params.toString();
  }

  const certTypeAutoMap = [
    { keyword: "营业执照", type: "business_license" },
    { keyword: "税", type: "tax_certificate" },
    { keyword: "专利", type: "patent" },
    { keyword: "资质", type: "qualification" },
    { keyword: "网络工程师", type: "network_engineer" },
    { keyword: "项目管理", type: "project_manager" },
    { keyword: "学历", type: "diploma" },
  ];

  function detectCertType(name) {
    const raw = (name || "").trim();
    if (!raw) return "";
    const hit = certTypeAutoMap.find(item => raw.includes(item.keyword));
    return hit ? hit.type : "";
  }

  function setModalMode(mode) {
    if (mode === "edit") {
      btnCompanyCertUpdate.classList.remove("hidden");
      btnPersonCertUpdate.classList.remove("hidden");
    } else {
      btnCompanyCertUpdate.classList.add("hidden");
      btnPersonCertUpdate.classList.add("hidden");
    }
  }

  function renderCertList(items) {
    if (!items || items.length === 0) {
      certTbody.innerHTML = `<tr><td colspan="5" class="muted">暂无数据</td></tr>`;
      return;
    }

    const rows = items.map(it => {
      const file = it.file || {};
      const certName = it.cert_no || "";
      const fileInfo = `
        <div><b>${escapeHtml(certName)}</b></div>
        <div class="small">${escapeHtml(file.mime_type || "")} · ${escapeHtml(file.size_bytes || "")} bytes</div>
        <div class="small">${escapeHtml(file.storage_rel_path || "")}</div>
      `;

      const itemPayload = escapeHtml(JSON.stringify(it));
      return `
        <tr data-cert='${itemPayload}'>
          <td class="nowrap">${escapeHtml(it.evidence_id || "")}</td>
          <td class="nowrap">${escapeHtml(it.owner_name || it.owner_id || "")}</td>
          <td>
            <div><b>${escapeHtml(it.doc_type_name || "")}</b></div>
            <div class="small">${escapeHtml(it.doc_type_code || "")}</div>
          </td>
          <td class="nowrap">${escapeHtml(it.status || "")}</td>
          <td>${fileInfo}</td>
        </tr>
      `;
    }).join("");

    certTbody.innerHTML = rows;

    certTbody.querySelectorAll("tr[data-cert]").forEach(row => {
      row.addEventListener("click", () => {
        const payload = row.getAttribute("data-cert");
        if (!payload) return;
        selectedCert = JSON.parse(payload);
        certEvidenceId.value = selectedCert.evidence_id || "";
        certSelectedLabel.textContent = selectedCert.evidence_id || "未选择";
        certLogLine(`selected: ${selectedCert.evidence_id || ""}`);
        openCertModal("edit");
        fillModalFromSelection(selectedCert);
      });
    });
  }

  async function fetchCertList(page) {
    const url = buildCertListUrl(page);
    certReqUrl.textContent = "GET " + url;
    certLogLine("list: " + url);

    try {
      const resp = await fetch(url, { method: "GET" });
      const data = await resp.json().catch(() => ({}));
      if (!resp.ok) throw new Error(data.message || `HTTP ${resp.status}`);

      certState.page = data.page || page;
      certState.total = data.total || 0;
      certPage.textContent = String(certState.page);
      certTotal.textContent = String(certState.total);
      renderCertList(data.items || []);

      certPrev.disabled = (certState.page <= 1);
      certNext.disabled = (certState.page * certPageSize >= certState.total);
    } catch (e) {
      certLogLine("error: " + (e.message || e));
      certTbody.innerHTML = `<tr><td colspan="5" class="muted">获取失败：${escapeHtml(e.message || e)}</td></tr>`;
    }
  }

  function openCertModal(mode) {
    setModalMode(mode);
    certCreateModal.classList.remove("hidden");
  }

  function closeCertModal() {
    certCreateModal.classList.add("hidden");
  }

  function fillModalFromSelection(data) {
    if (!data) return;
    if (data.scope === "COMPANY") {
      companyCertName.value = data.cert_no || data.doc_type_name || "";
      companyCertType.value = data.doc_type_code || "";
      personName.value = "";
      personCertName.value = "";
      personCertType.value = "";
    } else {
      personName.value = data.owner_name || "";
      personCertName.value = data.cert_no || data.doc_type_name || "";
      personCertType.value = data.doc_type_code || "";
      companyCertName.value = "";
      companyCertType.value = "";
    }
  }

  function resetCreateForm() {
    companyCertName.value = "";
    companyCertType.value = "";
    if (companyCertFile) companyCertFile.value = "";
    personName.value = "";
    personCertName.value = "";
    personCertType.value = "";
    if (personCertFile) personCertFile.value = "";
  }

  function getDocTypeName(selectEl) {
    if (!selectEl) return "";
    const option = selectEl.options[selectEl.selectedIndex];
    return option ? option.text : "";
  }

  function buildCreateFormData({ scope, ownerName, docTypeCode, docTypeName, certName, fileInput }) {
    const fd = new FormData();
    fd.append("scope", scope);
    fd.append("owner_name", ownerName || "");
    fd.append("doc_type_code", docTypeCode || "");
    fd.append("doc_type_name", docTypeName || "");
    fd.append("cert_no", certName || "");
    if (fileInput && fileInput.files && fileInput.files[0]) {
      fd.append("file", fileInput.files[0]);
    }
    return fd;
  }

  function buildUpdateFormData({ ownerName, docTypeCode, docTypeName, certName, fileInput }) {
    const fd = new FormData();
    if (ownerName) fd.append("owner_name", ownerName);
    if (docTypeCode) fd.append("doc_type_code", docTypeCode);
    if (docTypeName) fd.append("doc_type_name", docTypeName);
    if (certName) fd.append("cert_no", certName);
    if (fileInput && fileInput.files && fileInput.files[0]) {
      fd.append("file", fileInput.files[0]);
    }
    return fd;
  }

  btnCertOpenCreate.addEventListener("click", () => {
    selectedCert = null;
    certEvidenceId.value = "";
    certSelectedLabel.textContent = "未选择";
    resetCreateForm();
    openCertModal("create");
  });

  btnCertCloseCreate.addEventListener("click", closeCertModal);
  certCreateModal.querySelector(".modal-backdrop").addEventListener("click", closeCertModal);

  companyCertName.addEventListener("input", () => {
    const autoType = detectCertType(companyCertName.value);
    if (autoType) companyCertType.value = autoType;
  });

  personCertName.addEventListener("input", () => {
    const autoType = detectCertType(personCertName.value);
    if (autoType) personCertType.value = autoType;
  });

  btnCompanyCertCreate.addEventListener("click", async () => {
    if (!companyCertType.value) {
      certLogLine("error: 请填写证书类型");
      return;
    }
    if (!companyCertFile.files || !companyCertFile.files[0]) {
      certLogLine("error: 请上传公司证书图片");
      return;
    }

    try {
      const resp = await fetch("/api/v1/certs", {
        method: "POST",
        body: buildCreateFormData({
          scope: "COMPANY",
          ownerName: companyCertName.value || "未命名公司",
          docTypeCode: companyCertType.value,
          docTypeName: getDocTypeName(companyCertType),
          certName: companyCertName.value,
          fileInput: companyCertFile,
        }),
      });
      const data = await resp.json().catch(() => ({}));
      if (!resp.ok) throw new Error(data.message || `HTTP ${resp.status}`);
      certLogLine(`created company cert: ${data.evidence_id || ""}`);
      closeCertModal();
      fetchCertList(1);
    } catch (e) {
      certLogLine("error: " + (e.message || e));
    }
  });

  btnPersonCertCreate.addEventListener("click", async () => {
    if (!personName.value) {
      certLogLine("error: 请填写人员名称");
      return;
    }
    if (!personCertType.value) {
      certLogLine("error: 请填写证书类型");
      return;
    }
    if (!personCertFile.files || !personCertFile.files[0]) {
      certLogLine("error: 请上传人员证件图片");
      return;
    }

    try {
      const resp = await fetch("/api/v1/certs", {
        method: "POST",
        body: buildCreateFormData({
          scope: "PERSON",
          ownerName: personName.value,
          docTypeCode: personCertType.value,
          docTypeName: getDocTypeName(personCertType),
          certName: personCertName.value,
          fileInput: personCertFile,
        }),
      });
      const data = await resp.json().catch(() => ({}));
      if (!resp.ok) throw new Error(data.message || `HTTP ${resp.status}`);
      certLogLine(`created person cert: ${data.evidence_id || ""}`);
      closeCertModal();
      fetchCertList(1);
    } catch (e) {
      certLogLine("error: " + (e.message || e));
    }
  });

  btnCompanyCertUpdate.addEventListener("click", async () => {
    if (!selectedCert || selectedCert.scope !== "COMPANY") {
      certLogLine("error: 请先选中公司证书");
      return;
    }
    try {
      const resp = await fetch(`/api/v1/certs/${encodeURIComponent(selectedCert.evidence_id)}`, {
        method: "PUT",
        body: buildUpdateFormData({
          ownerName: selectedCert.owner_name,
          docTypeCode: companyCertType.value,
          docTypeName: getDocTypeName(companyCertType),
          certName: companyCertName.value,
          fileInput: companyCertFile,
        }),
      });
      const data = await resp.json().catch(() => ({}));
      if (!resp.ok) throw new Error(data.message || `HTTP ${resp.status}`);
      certLogLine(`updated company cert: ${selectedCert.evidence_id || ""}`);
      closeCertModal();
      fetchCertList(certState.page);
    } catch (e) {
      certLogLine("error: " + (e.message || e));
    }
  });

  btnPersonCertUpdate.addEventListener("click", async () => {
    if (!selectedCert || selectedCert.scope !== "PERSON") {
      certLogLine("error: 请先选中人员证件");
      return;
    }
    try {
      const resp = await fetch(`/api/v1/certs/${encodeURIComponent(selectedCert.evidence_id)}`, {
        method: "PUT",
        body: buildUpdateFormData({
          ownerName: personName.value,
          docTypeCode: personCertType.value,
          docTypeName: getDocTypeName(personCertType),
          certName: personCertName.value,
          fileInput: personCertFile,
        }),
      });
      const data = await resp.json().catch(() => ({}));
      if (!resp.ok) throw new Error(data.message || `HTTP ${resp.status}`);
      certLogLine(`updated person cert: ${selectedCert.evidence_id || ""}`);
      closeCertModal();
      fetchCertList(certState.page);
    } catch (e) {
      certLogLine("error: " + (e.message || e));
    }
  });

  btnCertDelete.addEventListener("click", async () => {
    const evidenceId = (certEvidenceId.value || "").trim();
    if (!evidenceId) {
      certLogLine("error: 请输入 evidence_id");
      return;
    }

    try {
      const resp = await fetch(`/api/v1/certs/${encodeURIComponent(evidenceId)}`, {
        method: "DELETE",
      });
      const data = await resp.json().catch(() => ({}));
      if (!resp.ok) throw new Error(data.message || `HTTP ${resp.status}`);
      certLogLine(`deleted: ${evidenceId}`);
      fetchCertList(1);
    } catch (e) {
      certLogLine("error: " + (e.message || e));
    }
  });

  certPrev.addEventListener("click", () => fetchCertList(Math.max(1, certState.page - 1)));
  certNext.addEventListener("click", () => fetchCertList(certState.page + 1));

  fetchCertList(1);

  // =======================
  // 2) KB Search + Export
  // =======================
  const kbQuery = el("kbQuery");
  const kbTag = el("kbTag");
  const kbTitleKeywords = el("kbTitleKeywords");
  const kbTopK = el("kbTopK");
  const kbPageSize = el("kbPageSize");

  const btnKbSearch = el("btnKbSearch");
  const btnKbReset = el("btnKbReset");
  const btnKbExport = el("btnKbExport");
  const btnKbPrev = el("btnKbPrev");
  const btnKbNext = el("btnKbNext");

  const kbTotal = el("kbTotal");
  const kbPage = el("kbPage");
  const kbReqInfo = el("kbReqInfo");
  const kbTbody = el("kbTbody");
  const kbPreview = el("kbPreview");
  const kbLog = el("kbLog");

  let kbState = { page: 1, total: 0, lastItems: [] };

  function kblog(msg) {
    const line = `[${new Date().toLocaleTimeString()}] ${msg}`;
    kbLog.textContent = (kbLog.textContent ? (kbLog.textContent + "\n") : "") + line;
    kbLog.scrollTop = kbLog.scrollHeight;
  }

  function parseTitleKeywords() {
    const s = (kbTitleKeywords.value || "").trim();
    if (!s) return null;
    const arr = s.split(",").map(x => x.trim()).filter(Boolean);
    return arr.length ? arr : null;
  }

  function renderKbItems(items) {
    kbState.lastItems = items || [];
    if (!items || items.length === 0) {
      kbTbody.innerHTML = `<tr><td colspan="4" class="muted">无结果</td></tr>`;
      return;
    }

    const rows = items.map((it, idx) => {
      const content = it.content_text || "";
      const preview = content.length > 240 ? (content.slice(0, 240) + "…") : content;

      return `
        <tr>
          <td class="nowrap">${escapeHtml(it.score ?? 0)}</td>
          <td>
            <div><b>${escapeHtml(it.section_title || "")}</b></div>
            <div class="small">doc_id: ${escapeHtml(it.doc_id || "")}</div>
            <div class="small">block_id: ${escapeHtml(it.block_id || "")}</div>
            <div class="small">docx_path: <span class="mono">${escapeHtml(it.content_docx_path || "")}</span></div>
          </td>
          <td>${escapeHtml(preview)}</td>
          <td class="nowrap">
            <button class="btn-mini secondary" data-action="preview" data-idx="${idx}">预览</button>
          </td>
        </tr>
      `;
    }).join("");

    kbTbody.innerHTML = rows;

    kbTbody.querySelectorAll('button[data-action="preview"]').forEach(btn => {
      btn.addEventListener("click", () => {
        const i = parseInt(btn.getAttribute("data-idx") || "0", 10);
        const it = kbState.lastItems[i];
        kbPreview.textContent = it ? (it.content_text || "") : "";
      });
    });
  }

  async function doKbSearch(page) {
    const q = (kbQuery.value || "").trim();
    if (!q) { alert("请输入关键词 query"); return; }

    const topK = Math.max(1, parseInt(kbTopK.value || "50", 10));
    const pageSize = Math.max(1, parseInt(kbPageSize.value || "20", 10));
    const tag = (kbTag.value || "").trim();
    const titleKw = parseTitleKeywords();

    const payload = {
      query: q,
      top_k: topK,
      by_tag: tag || null,
      title_keywords: titleKw,
      page: page,
      page_size: pageSize
    };

    kbReqInfo.textContent = "POST /api/v1/kb/search  " + JSON.stringify(payload);
    kblog("search: " + JSON.stringify(payload));

    btnKbSearch.disabled = true;
    try {
      const resp = await fetch("/api/v1/kb/search", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const data = await resp.json().catch(() => ({}));
      if (!resp.ok) throw new Error(data.message || `HTTP ${resp.status}`);

      kbState.page = data.page || page;
      kbState.total = data.total || 0;
      kbPage.textContent = String(kbState.page);
      kbTotal.textContent = String(kbState.total);

      renderKbItems(data.items || []);

      btnKbPrev.disabled = (kbState.page <= 1);
      btnKbNext.disabled = (kbState.page * pageSize >= kbState.total);

    } catch (e) {
      kblog("error: " + (e.message || e));
      kbTbody.innerHTML = `<tr><td colspan="4" class="muted">查询失败：${escapeHtml(e.message || e)}</td></tr>`;
    } finally {
      btnKbSearch.disabled = false;
    }
  }

  async function doKbExport() {
    const q = (kbQuery.value || "").trim();
    if (!q) { alert("请输入关键词 query"); return; }

    const topK = Math.max(1, parseInt(kbTopK.value || "50", 10));
    const tag = (kbTag.value || "").trim();
    const titleKw = parseTitleKeywords();

    const payload = {
      query: q,
      top_k: topK,
      by_tag: tag || null,
      title_keywords: titleKw
    };

    kblog("export: " + JSON.stringify(payload));
    btnKbExport.disabled = true;

    try {
      const resp = await fetch("/api/v1/kb/export", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!resp.ok) {
        const err = await resp.json().catch(() => ({}));
        throw new Error(err.message || `HTTP ${resp.status}`);
      }

      const blob = await resp.blob();
      downloadBlobAs(blob, "kb_export.docx");
      kblog("export done: kb_export.docx");
    } catch (e) {
      kblog("export error: " + (e.message || e));
      alert("导出失败：" + (e.message || e));
    } finally {
      btnKbExport.disabled = false;
    }
  }

  btnKbSearch.addEventListener("click", () => doKbSearch(1));
  btnKbPrev.addEventListener("click", () => doKbSearch(Math.max(1, kbState.page - 1)));
  btnKbNext.addEventListener("click", () => doKbSearch(kbState.page + 1));
  btnKbExport.addEventListener("click", doKbExport);

  btnKbReset.addEventListener("click", () => {
    kbQuery.value = "";
    kbTag.value = "";
    kbTitleKeywords.value = "";
    kbTopK.value = "50";
    kbPageSize.value = "20";
    kbState.page = 1;
    kbState.total = 0;
    kbState.lastItems = [];
    kbPage.textContent = "1";
    kbTotal.textContent = "0";
    kbReqInfo.textContent = "";
    kbLog.textContent = "";
    kbPreview.textContent = "";
    kbTbody.innerHTML = `<tr><td colspan="4" class="muted">请先检索</td></tr>`;
  });

  kbQuery.addEventListener("keydown", (e) => {
    if (e.key === "Enter") doKbSearch(1);
  });

  // =======================
  // 3) Review Index: Preview + Generate
  // =======================
  const riJobId = el("riJobId");
  const riKbTag = el("riKbTag");
  const riTopN = el("riTopN");
  const riTemplatePath = el("riTemplatePath");
  const riLimit = el("riLimit");

  const btnRiLoad = el("btnRiLoad");
  const btnRiGenerate = el("btnRiGenerate");
  const riReqCount = el("riReqCount");
  const riReqTbody = el("riReqTbody");
  const riLog = el("riLog");

  function rilog(msg) {
    const line = `[${new Date().toLocaleTimeString()}] ${msg}`;
    riLog.textContent = (riLog.textContent ? (riLog.textContent + "\n") : "") + line;
    riLog.scrollTop = riLog.scrollHeight;
  }

  function getReviewJobId() {
    const v = (riJobId.value || "").trim();
    return v || (state.job_id || "");
  }

  function renderReqRows(rows) {
    if (!rows || rows.length === 0) {
      riReqTbody.innerHTML = `<tr><td colspan="4" class="muted">无数据</td></tr>`;
      return;
    }
    riReqTbody.innerHTML = rows.map(r => `
      <tr>
        <td class="nowrap">${escapeHtml(r.category || "")}</td>
        <td class="nowrap">${escapeHtml(r.item || "")}</td>
        <td>${escapeHtml(r.value || "")}</td>
        <td>${escapeHtml(r.source || "")}</td>
      </tr>
    `).join("");
  }

  // 预览：从 job 的 artifact_xlsx_path 解析要求表（后端实现 /api/v1/review-index/preview）
  btnRiLoad.addEventListener("click", async () => {
    const jid = getReviewJobId();
    if (!jid) { alert("请先填写 job_id 或先运行任务生成 result.xlsx"); return; }

    const limit = Math.max(50, Math.min(2000, parseInt(riLimit.value || "200", 10)));
    const url = `/api/v1/review-index/preview?job_id=${encodeURIComponent(jid)}&limit=${limit}`;

    rilog("preview: " + url);
    btnRiLoad.disabled = true;

    try {
      const resp = await fetch(url, { method: "GET" });
      const data = await resp.json().catch(() => ({}));
      if (!resp.ok) throw new Error(data.message || `HTTP ${resp.status}`);

      const req = data.requirements || data.items || [];
      riReqCount.textContent = String(req.length);
      renderReqRows(req);

      if (data.meta) rilog("meta: " + JSON.stringify(data.meta));
      else rilog("preview ok");
    } catch (e) {
      rilog("preview error: " + (e.message || e));
      alert("预览失败：" + (e.message || e));
    } finally {
      btnRiLoad.disabled = false;
    }
  });

  // 生成：模板评分大类 + xlsx要求 + KB证据（后端实现 /api/v1/review-index/generate）
  btnRiGenerate.addEventListener("click", async () => {
    const jid = getReviewJobId();
    if (!jid) { alert("请先填写 job_id 或先运行任务生成 result.xlsx"); return; }

    const payload = {
      job_id: jid,
      kb_tag: (riKbTag.value || "").trim() || null,
      evidence_top_n: parseInt(riTopN.value || "3", 10),
      template_docx_path: (riTemplatePath.value || "").trim() || null
    };

    rilog("generate: " + JSON.stringify(payload));
    btnRiGenerate.disabled = true;

    try {
      const resp = await fetch("/api/v1/review-index/generate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!resp.ok) {
        const err = await resp.json().catch(() => ({}));
        throw new Error(err.message || `HTTP ${resp.status}`);
      }

      const blob = await resp.blob();
      downloadBlobAs(blob, "评审办法索引目录.docx");
      rilog("generate done: 评审办法索引目录.docx");
    } catch (e) {
      rilog("generate error: " + (e.message || e));
      alert("生成失败：" + (e.message || e));
    } finally {
      btnRiGenerate.disabled = false;
    }
  });

  // =======================
  // 4) Job Flow UI (existing)
  // =======================
  const fileInput = el("fileInput");
  const btnUpload = el("btnUpload");
  const fileIdEl = el("fileId");

  const scriptSelect = el("scriptSelect");
  const modelInput = el("modelInput");
  const btnCreateJob = el("btnCreateJob");
  const jobIdEl = el("jobId");

  const pillStatus = el("pillStatus");
  const pillStage = el("pillStage");
  const pillProgress = el("pillProgress");
  const progressBar = el("progressBar");

  const btnDownloadXlsx = el("btnDownloadXlsx");
  const btnDownloadJson = el("btnDownloadJson");
  const btnDownloadDocx = el("btnDownloadDocx");
  const btnReset = el("btnReset");

  const logEl = el("log");
  const jobListTbody = el("jobListTbody");

  let state = { file_id: null, job_id: null, poll_timer: null };
  let jobList = [];

  function renderJobList() {
    if (!jobList.length) {
      jobListTbody.innerHTML = `<tr><td colspan="3" class="muted">暂无任务</td></tr>`;
      return;
    }
    jobListTbody.innerHTML = jobList.map(job => {
      const status = job.status || "-";
      const art = [];
      if (job.xlsx_ready) art.push(`<a href="/api/v1/jobs/${job.job_id}/artifact?type=xlsx">xlsx</a>`);
      if (job.json_ready) art.push(`<a href="/api/v1/jobs/${job.job_id}/artifact?type=json">json</a>`);
      if (job.docx_ready) art.push(`<a href="/api/v1/jobs/${job.job_id}/artifact?type=docx">docx</a>`);
      return `
        <tr>
          <td class="nowrap">${job.job_id}</td>
          <td class="nowrap">${status}</td>
          <td>${art.length ? art.join(" / ") : "-"}</td>
        </tr>
      `;
    }).join("");
  }

  function upsertJob(job_id, status, flags) {
    const idx = jobList.findIndex(j => j.job_id === job_id);
    const rec = { job_id, status, ...flags };
    if (idx >= 0) jobList[idx] = { ...jobList[idx], ...rec };
    else jobList.push(rec);
    renderJobList();
  }

  function log(msg) {
    const line = `[${new Date().toLocaleTimeString()}] ${msg}`;
    logEl.textContent = (logEl.textContent ? (logEl.textContent + "\n") : "") + line;
    logEl.scrollTop = logEl.scrollHeight;
  }

  function setPill(pill, text, kind) {
    pill.textContent = text;
    pill.classList.remove("ok", "bad");
    if (kind) pill.classList.add(kind);
  }

  function setProgress(pct) {
    const p = Math.max(0, Math.min(100, parseInt(pct || 0, 10)));
    progressBar.style.width = p + "%";
    pillProgress.textContent = `progress: ${p}%`;
  }

  async function loadScripts() {
    scriptSelect.innerHTML = `<option value="">加载中...</option>`;
    try {
      const resp = await fetch("/api/v1/prompt-scripts", { method: "GET" });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const scripts = await resp.json();

      scriptSelect.innerHTML = `<option value="">请选择脚本</option>`;
      scripts.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.script_id;
        opt.textContent = `${s.name}  (${s.script_id} @ ${s.version})`;
        scriptSelect.appendChild(opt);
      });

      log(`脚本列表加载成功：${scripts.length} 个`);
    } catch (e) {
      scriptSelect.innerHTML = `<option value="">加载失败</option>`;
      log(`脚本列表加载失败：${e.message || e}`);
    }
  }

  function canCreateJob() {
    return !!state.file_id && !!scriptSelect.value && !!modelInput.value;
  }

  function refreshCreateButton() {
    btnCreateJob.disabled = !canCreateJob();
  }

  async function uploadFile() {
    const f = fileInput.files && fileInput.files[0];
    if (!f) { alert("请先选择文件"); return; }

    btnUpload.disabled = true;
    try {
      const fd = new FormData();
      fd.append("file", f);

      log(`开始上传：${f.name} (${f.size} bytes)`);
      const resp = await fetch("/api/v1/files/upload", { method: "POST", body: fd });
      const data = await resp.json().catch(() => ({}));

      if (!resp.ok) throw new Error(data.message || `Upload failed: HTTP ${resp.status}`);

      state.file_id = data.file_id;
      fileIdEl.textContent = state.file_id;

      log(`上传成功：file_id=${state.file_id}, ext=${data.ext}, size=${data.size}`);
      refreshCreateButton();
    } catch (e) {
      log(`上传失败：${e.message || e}`);
      alert(`上传失败：${e.message || e}`);
    } finally {
      btnUpload.disabled = false;
    }
  }

  async function createJob() {
    if (!canCreateJob()) { alert("请先上传文件并选择脚本/模型"); return; }

    btnCreateJob.disabled = true;
    btnDownloadXlsx.style.display = "none";
    btnDownloadJson.style.display = "none";
    btnDownloadDocx.style.display = "none";

    try {
      const payload = {
        file_id: state.file_id,
        script_id: scriptSelect.value,
        model_id: modelInput.value.trim(),
      };

      log(`创建任务：${JSON.stringify(payload)}`);
      const resp = await fetch("/api/v1/jobs", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const data = await resp.json().catch(() => ({}));
      if (!resp.ok) throw new Error(data.message || `Create job failed: HTTP ${resp.status}`);

      state.job_id = data.job_id;
      jobIdEl.textContent = state.job_id;

      // 便捷：自动填充到“评审办法索引目录”的 job_id 输入框
      if (riJobId && !riJobId.value) riJobId.value = state.job_id;

      setPill(pillStatus, "status: PENDING", null);
      setPill(pillStage, "stage: PENDING", null);
      setProgress(0);

      log(`任务创建成功：job_id=${state.job_id}`);
      upsertJob(state.job_id, "PENDING", { xlsx_ready: false, json_ready: false, docx_ready: false });

      startPolling();
    } catch (e) {
      log(`创建任务失败：${e.message || e}`);
      alert(`创建任务失败：${e.message || e}`);
      refreshCreateButton();
    }
  }

  function stopPolling() {
    if (state.poll_timer) { clearInterval(state.poll_timer); state.poll_timer = null; }
  }

  function startPolling() {
    stopPolling();
    state.poll_timer = setInterval(async () => {
      if (!state.job_id) return;

      try {
        const resp = await fetch(`/api/v1/jobs/${state.job_id}`, { method: "GET" });
        const j = await resp.json().catch(() => ({}));
        if (!resp.ok) throw new Error(j.message || `HTTP ${resp.status}`);

        const status = (j.status || "-").toUpperCase();
        const stage = (j.stage || "-");
        const progress = parseInt(j.progress || 0, 10);

        setPill(pillStatus, `status: ${status}`, status === "SUCCEEDED" ? "ok" : (status === "FAILED" ? "bad" : null));
        setPill(pillStage, `stage: ${stage}`, null);
        setProgress(progress);

        const flags = {
          xlsx_ready: status === "SUCCEEDED",
          json_ready: status === "SUCCEEDED",
          docx_ready: status === "SUCCEEDED",
        };
        upsertJob(state.job_id, status, flags);

        if (status === "FAILED") {
          stopPolling();
          log(`任务失败：${j.error || ""}`);
          alert(`任务失败：${j.error || ""}`);
          refreshCreateButton();
          return;
        }

        if (status === "SUCCEEDED") {
          stopPolling();
          log("任务完成，显示下载按钮");

          btnDownloadXlsx.href = `/api/v1/jobs/${state.job_id}/artifact?type=xlsx`;
          btnDownloadJson.href = `/api/v1/jobs/${state.job_id}/artifact?type=json`;
          btnDownloadDocx.href = `/api/v1/jobs/${state.job_id}/artifact?type=docx`;
          btnDownloadXlsx.style.display = "inline-block";
          btnDownloadJson.style.display = "inline-block";
          btnDownloadDocx.style.display = "inline-block";

          // 便捷：自动填充到“评审办法索引目录”的 job_id 输入框
          if (riJobId) riJobId.value = state.job_id;

          refreshCreateButton();
        }
      } catch (e) {
        log(`轮询异常：${e.message || e}`);
      }
    }, 600);

    log("开始轮询任务状态…");
  }

  function resetAll() {
    stopPolling();
    state.file_id = null;
    state.job_id = null;

    fileInput.value = "";
    fileIdEl.textContent = "-";
    jobIdEl.textContent = "-";

    setPill(pillStatus, "status: -", null);
    setPill(pillStage, "stage: -", null);
    setProgress(0);

    btnDownloadXlsx.style.display = "none";
    btnDownloadJson.style.display = "none";
    btnDownloadDocx.style.display = "none";

    logEl.textContent = "";
    loadScripts();
    refreshCreateButton();
  }

  btnUpload.addEventListener("click", uploadFile);
  btnCreateJob.addEventListener("click", createJob);
  btnReset.addEventListener("click", resetAll);

  scriptSelect.addEventListener("change", refreshCreateButton);
  modelInput.addEventListener("input", refreshCreateButton);

  // init
  loadScripts();
  refreshCreateButton();
})();
</script>
</body>
</html>
