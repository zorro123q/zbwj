<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>flask-gpt-stack MVP</title>
  <style>
    :root {
      color-scheme: light;
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --line: #e2e8f0;
      --accent: #111827;
      --accent-soft: #f1f5f9;
      --shadow: 0 10px 28px rgba(15, 23, 42, 0.08);
      --success: #10b981;
      --error: #ef4444;
    }
    * { box-sizing: border-box; }
    body {
      font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }
    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 28px 22px 60px;
      display: grid;
      gap: 18px;
    }
    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 20px 22px;
      background: linear-gradient(120deg, #111827 0%, #1f2937 50%, #0f172a 100%);
      color: #fff;
      border-radius: 18px;
      box-shadow: var(--shadow);
    }
    .page-header h1 {
      font-size: 20px;
      margin: 0 0 6px;
    }
    .page-header p {
      margin: 0;
      font-size: 13px;
      color: rgba(255, 255, 255, 0.8);
    }
    .card {
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 20px;
      box-shadow: var(--shadow);
      background: var(--card);
      display: grid;
      gap: 14px;
    }
    h1 { font-size: 18px; margin: 0; }
    h2 { font-size: 15px; margin: 0; }
    .section-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .section-title .muted { margin-top: 6px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .row > * { margin: 2px 0; }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px 16px;
      align-items: end;
    }
    .field {
      display: grid;
      gap: 6px;
    }
    label { font-size: 12px; color: var(--muted); font-weight: 600; }
    input[type="text"], input[type="number"], input[type="date"], select {
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 10px;
      min-width: 0;
      background: #fff;
      font-size: 13px;
      color: var(--text);
    }
    input[type="file"] { padding: 6px; }
    button {
      padding: 10px 14px;
      border: 1px solid var(--accent);
      background: var(--accent);
      color: white;
      border-radius: 10px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }
    button.secondary { background: white; color: var(--accent); }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .muted { color: var(--muted); font-size: 13px; }
    .hr { height: 1px; background: var(--line); margin: 6px 0; }
    .kv { font-size: 13px; color: var(--text); }
    .kv code { background: var(--accent-soft); padding: 2px 6px; border-radius: 6px; }
    .progress-wrap { width: 100%; max-width: 720px; height: 14px; border-radius: 999px; background: #f3f4f6; overflow: hidden; border: 1px solid var(--line); }
    .progress-bar { height: 100%; width: 0%; background: var(--accent); transition: width .2s ease; }
    .statusline { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid var(--line); background: #fafafa; }
    .pill.ok { border-color: #86efac; background: #f0fdf4; }
    .pill.bad { border-color: #fca5a5; background: #fef2f2; }
    a.btnlink { display: inline-block; padding: 9px 12px; border-radius: 10px; border: 1px solid var(--accent); text-decoration: none; font-size: 13px; }
    a.btnlink.primary { background: var(--accent); color: white; }
    a.btnlink.secondary { background: white; color: var(--accent); }
    pre { white-space: pre-wrap; word-break: break-word; background: #0b1020; color: #e5e7eb; padding: 12px; border-radius: 12px; font-size: 12px; max-height: 260px; overflow: auto; margin: 0; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid var(--line); padding: 8px; font-size: 13px; vertical-align: top; }
    th { background: #f8fafc; text-align: left; }
    .nowrap { white-space: nowrap; }
    .small { font-size: 12px; color: var(--muted); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .btn-mini { padding: 6px 10px; border-radius: 8px; font-size: 12px; }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      background: #f8fafc;
      border: 1px dashed var(--line);
      border-radius: 12px;
      padding: 10px 12px;
    }
    .file-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .file-meta {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="page-header">
      <div>
        <h1>flask-gpt-stack · 操作控制台</h1>
        <p>统一入口：证书索引、知识库检索、评审索引生成与任务闭环。</p>
      </div>
      <div class="small">MVP 控制台</div>
    </header>

    <div class="card">
      <div class="section-title">
        <div>
          <h1>第一步：证书索引</h1>
          <div class="muted">提示：如果数据库里还没导入对应数据，搜索会返回空。</div>
        </div>
        <div class="kv">total：<code id="searchTotal">0</code></div>
      </div>
      <div class="form-grid">
        <div class="field">
          <label>关键词 q（模糊查询）</label>
          <input id="searchQ" type="text" placeholder="例如：专利 / 营业执照 / 身份证正面" />
        </div>
        <div class="field">
          <label>scope</label>
          <select id="searchScope">
            <option value="">ALL</option>
            <option value="PERSON">PERSON</option>
            <option value="COMPANY">COMPANY</option>
          </select>
        </div>
        <div class="field">
          <label>page_size</label>
          <select id="searchPageSize">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
        <div class="field">
          <label>操作</label>
          <div class="row">
            <button id="btnSearch" type="button">搜索</button>
            <button id="btnSearchReset" type="button" class="secondary">清空</button>
          </div>
        </div>
      </div>
      <div class="toolbar">
        <div class="small" id="searchReqUrl"></div>
        <div class="row">
          <button id="btnPrev" type="button" class="secondary">上一页</button>
          <span class="kv">page：<code id="searchPage">1</code></span>
          <button id="btnNext" type="button" class="secondary">下一页</button>
        </div>
      </div>
      <div style="overflow:auto;">
        <table>
          <thead><tr><th>证书文件 (File)</th></tr></thead>
          <tbody id="searchTbody"><tr><td class="muted">请先搜索</td></tr></tbody>
        </table>
      </div>
      <div>
        <div class="muted">搜索日志</div>
        <pre id="searchLog"></pre>
      </div>
    </div>

    <div class="card">
      <div class="section-title">
        <div>
          <h1>第二步：知识库检索与导出</h1>
          <div class="muted">说明：招标文件已通过离线脚本切片入库。</div>
        </div>
        <div class="kv">total：<code id="kbTotal">0</code></div>
      </div>
      <div class="form-grid">
        <div class="field">
          <label>关键词 query</label>
          <input id="kbQuery" type="text" placeholder="例如：产品功能 / 技术方案 / 交付计划" />
        </div>
        <div class="field">
          <label>tag（可选）</label>
          <input id="kbTag" type="text" placeholder="例如：tender" />
        </div>
        <div class="field">
          <label>标题关键词（可选，逗号分隔）</label>
          <input id="kbTitleKeywords" type="text" placeholder="例如：功能,范围,需求" />
        </div>
        <div class="field">
          <label>top_k</label>
          <input id="kbTopK" type="number" value="50" min="1" max="500" />
        </div>
        <div class="field">
          <label>page_size</label>
          <select id="kbPageSize">
            <option value="5" selected>5</option>
            <option value="10">10</option>
            <option value="20">20</option>
          </select>
        </div>
        <div class="field">
          <label>操作</label>
          <div class="row">
            <button id="btnKbSearch" type="button">检索</button>
            <button id="btnKbReset" type="button" class="secondary">清空</button>
          </div>
        </div>
        <div class="field">
          <label>导出</label>
          <button id="btnKbExport" type="button" class="secondary">导出当前检索结果（docx）</button>
        </div>
      </div>
      <div class="toolbar">
        <div class="small" id="kbReqInfo"></div>
        <div class="row">
          <button id="btnKbPrev" type="button" class="secondary">上一页</button>
          <span class="kv">page：<code id="kbPage">1</code></span>
          <button id="btnKbNext" type="button" class="secondary">下一页</button>
        </div>
      </div>
      <div style="overflow:auto;">
        <table>
          <thead><tr><th>内容预览 (Content)</th><th class="nowrap">操作</th></tr></thead>
          <tbody id="kbTbody"><tr><td colspan="2" class="muted">请先检索</td></tr></tbody>
        </table>
      </div>
      <div>
        <div class="muted">选中内容（完整）</div>
        <pre id="kbPreview"></pre>
      </div>
      <div>
        <div class="muted">知识库日志</div>
        <pre id="kbLog"></pre>
      </div>
    </div>

    <div class="card">
      <div class="section-title">
        <div>
          <h1>第三步：任务闭环 (通用)</h1>
          <div class="muted">上传 → 选择脚本 → 创建任务 → 进度轮询 → 下载 XLSX/JSON/DOCX</div>
        </div>
        <div class="kv">job_id：<code id="jobId">-</code></div>
      </div>
      <div class="form-grid">
        <div class="field">
          <label>选择文件（txt/docx）</label>
          <input id="fileInput" type="file" accept=".txt,.docx" />
        </div>
        <div class="field">
          <label>上传</label>
          <button id="btnUpload" type="button">上传文件</button>
        </div>
        <div class="field">
          <label>file_id</label>
          <div class="kv"><code id="fileId">-</code></div>
        </div>
      </div>
      <div class="form-grid">
        <div class="field">
          <label>脚本选择</label>
          <select id="scriptSelect"><option value="">加载中...</option></select>
        </div>
        <div class="field">
          <label>模型 ID</label>
          <input id="modelInput" type="text" value="mock" />
        </div>
        <div class="field">
          <label>操作</label>
          <button id="btnCreateJob" type="button" disabled>创建任务</button>
        </div>
      </div>
      <div class="statusline">
        <span class="pill" id="pillStatus">status: -</span>
        <span class="pill" id="pillStage">stage: -</span>
        <span class="pill" id="pillProgress">progress: 0%</span>
      </div>
      <div><div class="progress-wrap"><div id="progressBar" class="progress-bar"></div></div></div>
      <div class="row">
        <a id="btnDownloadXlsx" class="btnlink primary" href="#" style="display:none;">下载 result.xlsx</a>
        <a id="btnDownloadJson" class="btnlink secondary" href="#" style="display:none;">下载 result.json</a>
        <a id="btnDownloadDocx" class="btnlink secondary" href="#" style="display:none;">下载 result.docx</a>
        <button id="btnReset" type="button" class="secondary">重置</button>
      </div>
      <div>
        <div class="muted">任务列表</div>
        <table>
          <thead><tr><th class="nowrap">job_id</th><th class="nowrap">status</th><th class="nowrap">artifact</th></tr></thead>
          <tbody id="jobListTbody"><tr><td colspan="3" class="muted">暂无任务</td></tr></tbody>
        </table>
      </div>
      <div>
        <div class="muted">任务日志</div>
        <pre id="log"></pre>
      </div>
    </div>

    <div class="card">
      <div class="section-title">
        <div><h1>第四步：一键生成评审办法索引</h1></div>
        <div class="kv">requirements：<code id="riReqCount">0</code></div>
      </div>
      <div class="form-grid">
        <div class="field">
          <label>job_id</label>
          <input id="riJobId" type="text" placeholder="例如：xxxx-xxxx-xxxx" />
        </div>
        <div class="field">
          <label>KB tag</label>
          <input id="riKbTag" type="text" value="tender" />
        </div>
        <div class="field">
          <label>每个评分大类证据条数</label>
          <input id="riTopN" type="number" value="3" min="1" max="10" />
        </div>
        <div class="field">
          <label>模板路径</label>
          <input id="riTemplatePath" type="text" value="storage/kb/templates/评分大类.docx" />
        </div>
        <div class="field">
          <label>预览条数 limit</label>
          <input id="riLimit" type="number" value="200" min="50" max="2000" />
        </div>
        <div class="field">
          <label>操作</label>
          <div class="row">
            <button id="btnRiLoad" type="button">预览要求表</button>
            <button id="btnRiGenerate" type="button" class="secondary">一键生成（docx）</button>
          </div>
        </div>
      </div>
      <div>
        <h2>招标文件要求表预览</h2>
        <div style="overflow:auto;">
          <table>
            <thead><tr><th class="nowrap">category</th><th class="nowrap">item</th><th>value</th><th>source</th></tr></thead>
            <tbody id="riReqTbody"><tr><td colspan="4" class="muted">请先预览</td></tr></tbody>
          </table>
        </div>
      </div>
      <div>
        <div class="muted">生成日志</div>
        <pre id="riLog"></pre>
      </div>
    </div>

    <div class="card">
      <div class="section-title">
        <div>
          <h1>第五步：文档相似度比对 (Similarity Check)</h1>
          <div class="muted">分别上传源文件与目标文件，进行语义查重。</div>
        </div>
        <div class="kv">job_id：<code id="simJobId">-</code></div>
      </div>

      <div class="form-grid">
        <div class="field">
          <label>源文件 (Source)</label>
          <div class="row">
            <input id="simFileSource" type="file" accept=".txt,.docx" />
            <button id="btnSimUploadSource" type="button" class="secondary btn-mini">上传</button>
          </div>
          <div class="small muted">ID: <code id="simSourceId">-</code></div>
        </div>

        <div class="field">
          <label>目标文件 (Target)</label>
          <div class="row">
            <input id="simFileTarget" type="file" accept=".txt,.docx" />
            <button id="btnSimUploadTarget" type="button" class="secondary btn-mini">上传</button>
          </div>
          <div class="small muted">ID: <code id="simTargetId">-</code></div>
        </div>

        <div class="field">
          <label>操作</label>
          <button id="btnSimStart" type="button" disabled>开始比对</button>
        </div>
      </div>

      <div class="statusline">
        <span class="pill" id="simPillStatus">status: -</span>
        <span class="pill" id="simPillStage">stage: -</span>
        <span class="pill" id="simPillProgress">progress: 0%</span>
      </div>

      <div class="progress-wrap">
        <div id="simProgressBar" class="progress-bar"></div>
      </div>

      <div class="row">
        <a id="btnSimDownloadReport" class="btnlink primary" href="#" style="display:none;">下载查重报告 (JSON)</a>
      </div>

      <div>
        <div class="muted">比对日志</div>
        <pre id="simLog"></pre>
      </div>
    </div>

  </div>

<script>
(function () {
  const el = (id) => document.getElementById(id);

  function escapeHtml(s) {
    return String(s ?? "")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;");
  }

  function downloadBlobAs(blob, filename) {
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    window.URL.revokeObjectURL(url);
  }

  // =======================
  // 1) 证书索引 Search
  // =======================
  const searchQ = el("searchQ"); const searchScope = el("searchScope");
  const searchPageSize = el("searchPageSize"); const btnSearch = el("btnSearch");
  const btnSearchReset = el("btnSearchReset"); const btnPrev = el("btnPrev");
  const btnNext = el("btnNext"); const searchTotal = el("searchTotal");
  const searchPage = el("searchPage"); const searchReqUrl = el("searchReqUrl");
  const searchTbody = el("searchTbody"); const searchLog = el("searchLog");
  let searchState = { page: 1, total: 0 };
  function slog(msg) { searchLog.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`; searchLog.scrollTop = searchLog.scrollHeight; }
  function buildSearchUrl(page) {
    const params = new URLSearchParams();
    if(searchQ.value.trim()) params.set("q", searchQ.value.trim());
    if(searchScope.value.trim()) params.set("scope", searchScope.value.trim());
    params.set("page_size", searchPageSize.value);
    params.set("page", page);
    return "/api/v1/index/search?" + params.toString();
  }
  function renderIndexItems(items) {
    if (!items || !items.length) { searchTbody.innerHTML = `<tr><td class="muted">无结果</td></tr>`; return; }
    searchTbody.innerHTML = items.map(it => {
      const f = it.file || {};
      const fid = f.file_id || "";
      return `<tr><td><div class="file-card"><div class="file-meta"><div><b>${escapeHtml(f.original_name||"Untitled")}</b></div><div class="small">${escapeHtml(f.mime_type)} · ${f.size_bytes||0}</div></div><div>${fid?`<a href="/api/v1/files/${encodeURIComponent(fid)}/download" target="_blank" class="btnlink secondary btn-mini">下载</a>`:`<span class="muted small">无文件</span>`}</div></div></td></tr>`;
    }).join("");
  }
  async function doIndexSearch(page) {
    const url = buildSearchUrl(page);
    searchReqUrl.textContent = "GET " + url; slog("search: " + url);
    btnSearch.disabled = true;
    try {
      const resp = await fetch(url);
      const data = await resp.json().catch(()=>({}));
      if(!resp.ok) throw new Error(data.message||resp.statusText);
      searchState.page = data.page||page; searchState.total = data.total||0;
      searchPage.textContent = searchState.page; searchTotal.textContent = searchState.total;
      renderIndexItems(data.items);
      btnPrev.disabled = searchState.page <= 1;
      btnNext.disabled = searchState.page * searchPageSize.value >= searchState.total;
    } catch(e) { slog("error: "+e.message); searchTbody.innerHTML=`<tr><td class="muted">失败: ${escapeHtml(e.message)}</td></tr>`; }
    finally { btnSearch.disabled = false; }
  }
  btnSearch.addEventListener("click", ()=>doIndexSearch(1));
  btnPrev.addEventListener("click", ()=>doIndexSearch(Math.max(1, searchState.page-1)));
  btnNext.addEventListener("click", ()=>doIndexSearch(searchState.page+1));
  btnSearchReset.addEventListener("click", ()=>{ searchQ.value=""; searchScope.value=""; searchPageSize.value="20"; searchState.page=1; searchState.total=0; searchPage.textContent="1"; searchTotal.textContent="0"; searchTbody.innerHTML=`<tr><td class="muted">请先搜索</td></tr>`; });

  // =======================
  // 2) KB Search
  // =======================
  const kbQuery=el("kbQuery"); const kbTag=el("kbTag"); const kbTitleKeywords=el("kbTitleKeywords");
  const kbTopK=el("kbTopK"); const kbPageSize=el("kbPageSize"); const btnKbSearch=el("btnKbSearch");
  const btnKbReset=el("btnKbReset"); const btnKbExport=el("btnKbExport");
  const btnKbPrev=el("btnKbPrev"); const btnKbNext=el("btnKbNext");
  const kbTotal=el("kbTotal"); const kbPage=el("kbPage"); const kbReqInfo=el("kbReqInfo");
  const kbTbody=el("kbTbody"); const kbPreview=el("kbPreview"); const kbLog=el("kbLog");
  let kbState={ page:1, total:0, lastItems:[] };
  function kblog(msg) { kbLog.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`; kbLog.scrollTop=kbLog.scrollHeight; }
  function renderKbItems(items) {
    kbState.lastItems=items||[];
    if(!items||!items.length) { kbTbody.innerHTML=`<tr><td colspan="2" class="muted">无结果</td></tr>`; return; }
    kbTbody.innerHTML = items.map((it,i) => {
      const prev = (it.content_text||"").slice(0,240)+(it.content_text.length>240?"...":"");
      return `<tr><td>${escapeHtml(prev)}</td><td class="nowrap"><button class="btn-mini secondary" data-action="preview" data-idx="${i}">预览</button></td></tr>`;
    }).join("");
    kbTbody.querySelectorAll('button[data-action="preview"]').forEach(b=>{
      b.addEventListener("click", ()=>{
        const item = kbState.lastItems[b.getAttribute("data-idx")];
        kbPreview.textContent = item?item.content_text:"";
      });
    });
  }
  async function doKbSearch(page) {
    if(!kbQuery.value.trim()) { alert("请输入关键词"); return; }
    const payload={ query:kbQuery.value.trim(), top_k:parseInt(kbTopK.value), by_tag:kbTag.value.trim()||null, title_keywords:kbTitleKeywords.value.split(",").map(x=>x.trim()).filter(Boolean), page, page_size:parseInt(kbPageSize.value) };
    kbReqInfo.textContent = "POST /api/v1/kb/search " + JSON.stringify(payload);
    btnKbSearch.disabled=true;
    try {
      const resp = await fetch("/api/v1/kb/search", { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload)});
      const data = await resp.json().catch(()=>({}));
      if(!resp.ok) throw new Error(data.message||resp.statusText);
      kbState.page = data.page||page; kbState.total = data.total||0;
      kbPage.textContent = kbState.page; kbTotal.textContent = kbState.total;
      renderKbItems(data.items);
      btnKbPrev.disabled = kbState.page<=1;
      btnKbNext.disabled = kbState.page*parseInt(kbPageSize.value)>=kbState.total;
    } catch(e) { kblog("error: "+e.message); } finally { btnKbSearch.disabled=false; }
  }
  btnKbSearch.addEventListener("click", ()=>doKbSearch(1));
  btnKbPrev.addEventListener("click", ()=>doKbSearch(Math.max(1, kbState.page-1)));
  btnKbNext.addEventListener("click", ()=>doKbSearch(kbState.page+1));
  btnKbReset.addEventListener("click", ()=>{ kbQuery.value=""; kbTbody.innerHTML=`<tr><td colspan="2" class="muted">请先检索</td></tr>`; });
  btnKbExport.addEventListener("click", async()=>{
    if(!kbQuery.value.trim()){ alert("请输入关键词"); return; }
    btnKbExport.disabled=true;
    try {
      const payload={ query:kbQuery.value.trim(), top_k:parseInt(kbTopK.value), by_tag:kbTag.value.trim()||null, title_keywords:kbTitleKeywords.value.split(",").map(x=>x.trim()).filter(Boolean) };
      const resp = await fetch("/api/v1/kb/export", { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload)});
      if(!resp.ok) throw new Error((await resp.json()).message||resp.statusText);
      downloadBlobAs(await resp.blob(), "kb_export.docx");
    } catch(e) { alert("导出失败: "+e.message); } finally { btnKbExport.disabled=false; }
  });

  // =======================
  // 3) Job Flow
  // =======================
  const fileInput=el("fileInput"); const btnUpload=el("btnUpload"); const fileIdEl=el("fileId");
  const scriptSelect=el("scriptSelect"); const modelInput=el("modelInput"); const btnCreateJob=el("btnCreateJob");
  const jobIdEl=el("jobId"); const pillStatus=el("pillStatus"); const pillStage=el("pillStage");
  const pillProgress=el("pillProgress"); const progressBar=el("progressBar");
  const btnReset=el("btnReset"); const logEl=el("log"); const jobListTbody=el("jobListTbody");
  const btnDlXlsx=el("btnDownloadXlsx"); const btnDlJson=el("btnDownloadJson"); const btnDlDocx=el("btnDownloadDocx");
  let jobState={ file_id:null, job_id:null, timer:null, list:[] };
  function log(msg) { logEl.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`; logEl.scrollTop=logEl.scrollHeight; }
  function renderJobList() {
    if(!jobState.list.length) { jobListTbody.innerHTML=`<tr><td colspan="3" class="muted">暂无任务</td></tr>`; return; }
    jobListTbody.innerHTML = jobState.list.map(j=>`<tr><td>${j.job_id}</td><td>${j.status}</td><td>${j.status==='SUCCEEDED'?'Ready':'-'}</td></tr>`).join("");
  }
  function refreshCreateBtn() { btnCreateJob.disabled = !jobState.file_id || !scriptSelect.value; }
  async function loadScripts() {
    try {
      const resp = await fetch("/api/v1/prompt-scripts");
      const data = await resp.json();
      scriptSelect.innerHTML = `<option value="">请选择脚本</option>`+data.map(s=>`<option value="${s.script_id}">${s.name}</option>`).join("");
    } catch(e) { scriptSelect.innerHTML=`<option>加载失败</option>`; }
  }
  btnUpload.addEventListener("click", async()=>{
    if(!fileInput.files[0]) return;
    btnUpload.disabled=true;
    const fd = new FormData(); fd.append("file", fileInput.files[0]);
    try {
      const resp = await fetch("/api/v1/files/upload", { method:"POST", body:fd });
      const data = await resp.json();
      if(!resp.ok) throw new Error(data.message);
      jobState.file_id=data.file_id; fileIdEl.textContent=data.file_id; log("上传成功: "+data.file_id);
    } catch(e) { alert("上传失败: "+e.message); } finally { btnUpload.disabled=false; refreshCreateBtn(); }
  });
  btnCreateJob.addEventListener("click", async()=>{
    btnCreateJob.disabled=true;
    try {
      const resp = await fetch("/api/v1/jobs", { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({file_id:jobState.file_id, script_id:scriptSelect.value, model_id:modelInput.value}) });
      const data = await resp.json();
      if(!resp.ok) throw new Error(data.message);
      jobState.job_id=data.job_id; jobIdEl.textContent=data.job_id; riJobId.value=data.job_id;
      log("任务ID: "+data.job_id);
      jobState.list.push({job_id:data.job_id, status:"PENDING"}); renderJobList();
      startJobPolling();
    } catch(e) { log("错误: "+e.message); btnCreateJob.disabled=false; }
  });
  function startJobPolling() {
    if(jobState.timer) clearInterval(jobState.timer);
    jobState.timer = setInterval(async()=>{
      if(!jobState.job_id) return;
      const resp = await fetch(`/api/v1/jobs/${jobState.job_id}`);
      const j = await resp.json();
      pillStatus.textContent="status: "+j.status; pillStage.textContent="stage: "+(j.stage||"-");
      pillProgress.textContent=`progress: ${j.progress}%`; progressBar.style.width=j.progress+"%";
      pillStatus.className = "pill "+(j.status==="SUCCEEDED"?"ok":j.status==="FAILED"?"bad":"");
      if(j.status==="SUCCEEDED" || j.status==="FAILED") {
        clearInterval(jobState.timer);
        const idx = jobState.list.findIndex(x=>x.job_id===jobState.job_id);
        if(idx>=0) { jobState.list[idx].status=j.status; renderJobList(); }
        if(j.status==="SUCCEEDED") {
           btnDlXlsx.href=`/api/v1/jobs/${jobState.job_id}/artifact?type=xlsx`; btnDlXlsx.style.display="inline-block";
        }
      }
    }, 1000);
  }
  scriptSelect.addEventListener("change", refreshCreateBtn);
  loadScripts();
  btnReset.addEventListener("click", ()=>location.reload());

  // =======================
  // 4) Review Index
  // =======================
  const riJobId=el("riJobId"); const riKbTag=el("riKbTag"); const riTopN=el("riTopN");
  const riTemplatePath=el("riTemplatePath"); const riLimit=el("riLimit");
  const btnRiLoad=el("btnRiLoad"); const btnRiGenerate=el("btnRiGenerate");
  const riReqCount=el("riReqCount"); const riReqTbody=el("riReqTbody"); const riLog=el("riLog");
  function rilog(msg) { riLog.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`; riLog.scrollTop=riLog.scrollHeight; }
  function getJid() { return (riJobId.value||"").trim() || (jobState.job_id||""); }
  btnRiLoad.addEventListener("click", async()=>{
    const jid = getJid(); if(!jid) { alert("无 Job ID"); return; }
    btnRiLoad.disabled=true;
    try {
      const resp = await fetch(`/api/v1/review-index/preview?job_id=${encodeURIComponent(jid)}&limit=${riLimit.value}`);
      const data = await resp.json();
      if(!resp.ok) throw new Error(data.message);
      const req = data.requirements||data.items||[];
      riReqCount.textContent=req.length;
      riReqTbody.innerHTML = req.map(r=>`<tr><td class="nowrap">${escapeHtml(r.category)}</td><td class="nowrap">${escapeHtml(r.item)}</td><td>${escapeHtml(r.value)}</td><td>${escapeHtml(r.source)}</td></tr>`).join("");
      rilog("preview ok");
    } catch(e) { rilog("error: "+e.message); } finally { btnRiLoad.disabled=false; }
  });
  btnRiGenerate.addEventListener("click", async()=>{
    const jid = getJid(); if(!jid) { alert("无 Job ID"); return; }
    btnRiGenerate.disabled=true;
    try {
      const payload={ job_id:jid, kb_tag:riKbTag.value.trim()||null, evidence_top_n:parseInt(riTopN.value), template_docx_path:riTemplatePath.value.trim()||null };
      const resp = await fetch("/api/v1/review-index/generate", { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload)});
      if(!resp.ok) throw new Error((await resp.json()).message);
      downloadBlobAs(await resp.blob(), "评审索引.docx");
      rilog("generated");
    } catch(e) { rilog("error: "+e.message); } finally { btnRiGenerate.disabled=false; }
  });

  // =======================
  // 5) Similarity Check (Enhanced)
  // =======================
  const simFileSource = el("simFileSource"); const simFileTarget = el("simFileTarget");
  const btnSimUploadSource = el("btnSimUploadSource"); const btnSimUploadTarget = el("btnSimUploadTarget");
  const simSourceId = el("simSourceId"); const simTargetId = el("simTargetId");
  const btnSimStart = el("btnSimStart"); const simJobIdEl = el("simJobId");
  const simPillStatus = el("simPillStatus"); const simPillStage = el("simPillStage");
  const simPillProgress = el("simPillProgress"); const simProgressBar = el("simProgressBar");
  const btnSimDownloadReport = el("btnSimDownloadReport"); const simLog = el("simLog");
  let simState = { source_id: null, target_id: null, job_id: null, timer: null };

  function simlog(msg) {
    simLog.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
    simLog.scrollTop = simLog.scrollHeight;
  }
  function refreshSimButton() {
    btnSimStart.disabled = !(simState.source_id && simState.target_id);
  }

  function uploadSimFile(fileInputEl, label, btnEl) {
    return new Promise((resolve) => {
      if (!fileInputEl.files[0]) return resolve(null);
      const file = fileInputEl.files[0];
      const fd = new FormData(); fd.append("file", file);

      simlog(`Start uploading ${label} (${file.size} bytes)...`);
      btnEl.disabled = true;

      const xhr = new XMLHttpRequest();
      xhr.open("POST", "/api/v1/files/upload", true);

      xhr.upload.onprogress = (e) => {
        if (e.lengthComputable) {
          const p = Math.round((e.loaded / e.total) * 100);
          btnEl.innerText = `${p}%`;
        }
      };

      xhr.onload = () => {
        btnEl.disabled = false;
        if (xhr.status >= 200 && xhr.status < 300) {
          try {
            const data = JSON.parse(xhr.responseText);
            simlog(`${label} uploaded: ${data.file_id}`);
            resolve(data.file_id);
          } catch (e) {
            simlog(`Response parse error: ${e.message}`);
            alert(`上传成功但解析失败，请看日志`);
            resolve(null);
          }
        } else {
          // 尝试解析错误信息
          let errMsg = `HTTP ${xhr.status}`;
          try {
            const err = JSON.parse(xhr.responseText);
            if(err.message) errMsg = err.message;
            if(err.error) errMsg += ` (${err.error})`;
          } catch(e){}

          simlog(`Upload Error: ${errMsg}`);
          alert(`上传失败: ${errMsg}\n如果是 413 错误，请确保后端 config.py 已修改并重启。`);
          btnEl.innerText = "重试";
          resolve(null);
        }
      };

      xhr.onerror = () => {
        btnEl.disabled = false;
        btnEl.innerText = "重试";
        simlog(`Network Error for ${label}`);
        alert("网络错误，上传失败。");
        resolve(null);
      };

      xhr.send(fd);
    });
  }

  btnSimUploadSource.addEventListener("click", async () => {
    const fid = await uploadSimFile(simFileSource, "Source", btnSimUploadSource);
    if (fid) {
      simState.source_id = fid; simSourceId.textContent = fid;
      btnSimUploadSource.innerText = "✅ 成功";
      btnSimUploadSource.style.background = "var(--success)";
      btnSimUploadSource.style.borderColor = "var(--success)";
      setTimeout(()=>{
         btnSimUploadSource.innerText="重新上传";
         btnSimUploadSource.style.background="";
         btnSimUploadSource.style.borderColor="";
      }, 2000);
    }
    refreshSimButton();
  });

  btnSimUploadTarget.addEventListener("click", async () => {
    const fid = await uploadSimFile(simFileTarget, "Target", btnSimUploadTarget);
    if (fid) {
      simState.target_id = fid; simTargetId.textContent = fid;
      btnSimUploadTarget.innerText = "✅ 成功";
      btnSimUploadTarget.style.background = "var(--success)";
      btnSimUploadTarget.style.borderColor = "var(--success)";
      setTimeout(()=>{
         btnSimUploadTarget.innerText="重新上传";
         btnSimUploadTarget.style.background="";
         btnSimUploadTarget.style.borderColor="";
      }, 2000);
    }
    refreshSimButton();
  });

  btnSimStart.addEventListener("click", async () => {
    if (!simState.source_id || !simState.target_id) return;
    btnSimStart.disabled = true;
    simlog("Creating similarity check job...");
    try {
      const resp = await fetch("/api/v1/similarity/check", {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ source_file_id: simState.source_id, target_file_id: simState.target_id })
      });
      const data = await resp.json();
      if (!resp.ok) throw new Error(data.message||resp.statusText);

      simState.job_id = data.job_id; simJobIdEl.textContent = data.job_id;
      simlog(`Job created: ${data.job_id}`);
      startSimPolling();
    } catch(e) {
      simlog("Error creating job: " + e.message);
      alert("创建任务失败: " + e.message);
      btnSimStart.disabled = false;
    }
  });

  function startSimPolling() {
    if (simState.timer) clearInterval(simState.timer);
    simState.timer = setInterval(async () => {
      if (!simState.job_id) return;
      const resp = await fetch(`/api/v1/jobs/${simState.job_id}`);
      const j = await resp.json();

      simPillStatus.textContent = "status: " + j.status;
      simPillStatus.className = "pill " + (j.status==="SUCCEEDED"?"ok":j.status==="FAILED"?"bad":"");
      simPillStage.textContent = "stage: " + (j.stage || "-");
      simPillProgress.textContent = `progress: ${j.progress}%`;
      simProgressBar.style.width = j.progress + "%";

      if (j.status === "SUCCEEDED" || j.status === "FAILED") {
        clearInterval(simState.timer);
        btnSimStart.disabled = false;
        simlog(`Job finished: ${j.status}`);
        if (j.status === "SUCCEEDED") {
          btnSimDownloadReport.href = `/api/v1/jobs/${simState.job_id}/artifact?type=json`;
          btnSimDownloadReport.style.display = "inline-block";
        } else {
          simlog(`Error: ${j.error_message}`);
          alert("比对任务失败: " + j.error_message);
        }
      }
    }, 1000);
  }

})();
</script>
</body>
</html>